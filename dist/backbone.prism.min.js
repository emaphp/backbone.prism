!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore","flux","backbone.radio"],function(c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){require("backbone.radio");module.exports=b(a,require("backbone"),require("underscore"),require("flux"))}else b(a,a.Backbone,a._,a.Flux)}(this,function(a,b,c,d){var e=b.Prism=b.Prism||{};e.VERSION="1.2.0",e.extend=b.Model.extend;var f=function(a,b){a&&c.extend(this,c.pick(a,b))},g=function(a,b){return a&&b?a.options&&void 0!==a.options[b]?a.options[b]:a[b]:void 0},h=function(a){return g(this,a)},i=function(){return this.trigger("destroy"),this.stopListening(),this.off(),this};e.Object=function(a){this.options=c.extend({},c.result(this,"options"),a),this.initialize.apply(this,arguments)},e.Object.extend=e.extend,c.extend(e.Object.prototype,b.Events,{initialize:function(){},mergeOptions:f,getOption:h,destroy:i}),e.Channel=e.Object.extend(c.extend({destroy:function(){return this.off(),this.stopListening(),this.stopReplying(),this}},b.Radio.Requests)),e.Events=c.extend({},b.Events,b.Radio.Requests),e.Dispatcher=function(){d.Dispatcher.prototype.constructor.apply(this,arguments)},e.Dispatcher.prototype=new d.Dispatcher,c.extend(e.Dispatcher.prototype,{handleViewAction:function(a){return this.dispatch({source:"view",action:a})},handleServerAction:function(a){return this.dispatch({source:"server",action:a})}});var j=e.Object.extend({initialize:function(a,b,c){this.parent=a,this.context=b,this.callback=c,a.on("wakeup",function(){this.apply(!0)}.bind(this))},apply:function(a){c.extend(this.parent.options,this.callback.call(this.context)),a!==!0&&this.trigger("apply",a)},update:function(a,b){c.extend(this.context.state,a),this.apply(b)}});e.ViewMutator=j;var k=j.extend({apply:function(a){c.extend(this.parent.options,{comparator:this.callback.call(this.context)}),a!==!0&&this.trigger("apply")}});e.ViewComparator=k;var l=j.extend({apply:function(a){this.parent.options.filters=this.parent.options.filters||{},this.parent.options.filters[this.cid]=this.callback.call(this.context),a!==!0&&this.trigger("apply")}});e.ViewFilter=l;var m={_isInitialized:!1,start:function(){this.trigger("start"),this._isInitialized=!0}},n=c.extend({mutators:{},isInitialized:function(){return!!this._isInitialized},createMutator:function(a,b){var d=new j(this,b,a);return d.cid=c.uniqueId("mutator"),this._storeMutator(d),d},_storeMutator:function(a){this.listenTo(a,"apply",function(a){a||this.sync()}),this.listenTo(a,"destroy",function(){this.stopListening(a),delete this.mutators[a.cid],this.sync()}),this.mutators[a.cid]=a},isActive:function(){return!!this._isActive},sleep:function(){this.stopListening(this.parent,this.options.listenTo),this._isActive=!1},wakeup:function(a){this.listenTo(this.parent,this.options.listenTo,this.sync),this._isActive=!0,a!==!1&&this.sync()}},b.Events),o={views:{},getView:function(a){return this.views[a]},getDefaultView:function(a){return this.views["default"]?this.views["default"]:this.createView(c.extend(a||{},{name:"default"}))}},p={createView:function(a){a=a||{};var b=new r(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,this.listenTo(b,"destroy",function(){delete this.views[b.name]}),b}};c.extend(p,o);var q={createView:function(a){a=a||{};var b=new s(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,this.listenTo(b,"destroy",function(){delete this.views[b.name]}),b}};c.extend(q,o);var r=e.StateView=function(a,b){this.parent=a,this.options=c.extend({},c.result(this,"options"),b),this.options.listenTo=this.options.listenTo||"change",this._isInitialized=!1,this._isActive=!1,this.listenTo(a,"start",function(){this.trigger("wakeup"),this.wakeup(!1),this._isInitialized=!0,this.sync(),this.trigger("start")}),this.initialize.apply(this,arguments)};c.extend(r.prototype,n,p,{initialize:function(){},sync:function(){this._isActive&&(this.attributes=this.parent.cid?c.extend({cid:this.parent.cid},this.parent.attributes):c.extend({},this.parent.attributes),this.trigger("sync"))},toJSON:function(){return c.extend({cid:this.parent.cid},this.attributes)},destroy:i}),r.extend=b.Model.extend,e.StateMixin=c.extend({constructor:function(a,b){var d=a||{};b=b||{},this.cid=c.uniqueId("c"),this.attributes={},this.views={},b.collection&&(this.collection=b.collection),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this.changed={},this.initialize.apply(this,arguments)}},m,p),e.State=b.Model.extend(e.StateMixin);var s=e.StoreView=function(a,b){this.parent=a,this.models=[],this.length=0,this._isInitialized=!1,this.options=c.extend({},c.result(this,"options"),b),this.options.listenTo=this.options.listenTo||"add remove change reset",this.listenTo(a,"start",function(){this.trigger("wakeup"),this.wakeup(!1),this._isInitialized=!0,this.sync(),this.trigger("start")}),this.initialize.apply(this,arguments)};c.extend(s.prototype,n,q,{initialize:function(){},sync:function(){if(this._isActive){if(this.models=c.clone(this.parent.models),this.options.filter)if(c.isFunction(this.options.filter))this.models=this.filter(this.options.filter);else if(c.isObject(this.options.filter)){var a=c.matches(this.options.filter);this.models=this.filter(function(b){return a(b.attributes)})}if(this.options.filters&&c.each(this.options.filters,function(a){if(c.isFunction(a))this.models=this.filter(a);else if(c.isObject()){var b=c.matches(a);this.models=this.filter(function(a){return b(a.attributes)})}}.bind(this)),this.options.comparator&&(c.isString(this.options.comparator)||1===this.options.comparator.length?this.models=this.sortBy(this.options.comparator,this):this.models.sort(c.bind(this.options.comparator,this))),this.options.size||"undefined"!=typeof this.options.offset){var b=this.models.length,d=this.options.size||b,e="undefined"==typeof this.options.offset?0:Math.abs(this.options.offset);if(d>0)this.models=this.models.slice(e,e+d);else if(0>d){var f=Math.abs(b+d-e);this.models=this.models.slice(f,b-e)}}this.length=this.models.length,this.trigger("sync")}},toJSON:function(){return this.models.map(function(a){return c.extend({cid:a.cid},a.toJSON())})},createFilter:function(a,b){var d=new l(this,b,a);return d.cid=c.uniqueId("filter"),this._storeMutator(d),d},createComparator:function(a,b){var d=new k(this,b,a);return d.cid=c.uniqueId("comparator"),this._storeMutator(d),d},destroy:i});var t=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","includes","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample","partition"];c.each(t,function(a){s.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}}),c.each(["groupBy","countBy","sortBy","indexBy"],function(a){s.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)}}),s.extend=b.Model.extend,e.StoreMixin=c.extend({constructor:function(a,b){b=b||{},b.model&&(this.model=b.model),b.comparator&&(this.comparator=b.comparator),this._reset(),this.views={},this.initialize.apply(this,arguments),a&&this.reset(a,c.extend({silent:!0},b))}},m,q),e.Store=b.Collection.extend(e.StoreMixin);var u=function(a,b,d){c.isFunction(d.prototype.transform)?a.setState(d.prototype.transform.call(a,b)):a.setState({view:b.toJSON()})};return e.compose=function(a,b,d){var f=a.createClass({componentWillMount:function(){this.listenTo(this.props.view,"sync",function(){c.isFunction(d)?d(this,this.props.view,b,arguments):u(this,this.props.view,b)})},componentWillUnmount:function(){this.stopListening(this.props.view,"sync")},render:function(){var d=this,e={values:function(a){return void 0!==a?d.state[a]:d.state?d.state:{}}};return a.createElement(b,c.extend(e,this.props))}});return c.extend(f.prototype,e.Events),f},e});