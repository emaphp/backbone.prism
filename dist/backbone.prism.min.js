!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore","flux","backbone.radio"],function(c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){require("backbone.radio");module.exports=b(a,require("backbone"),require("underscore"),require("flux"))}else b(a,a.Backbone,a._,a.Flux)}(this,function(a,b,c,d){function e(a,b){this.state=a,this.options=c.extend({},c.result(this,"options"),b),this._isInitialized=!1,this.listenTo(a,"start",function(){this.trigger("start"),this.listenTo(a,this.options.listenTo?this.options.listenTo:"change",this.sync),this.sync(),this._isInitialized=!0}),this.initialize.apply(this,arguments)}function f(a,b){this.store=a,this.models=[],this.length=0,this._isInitialized=!1,this.options=c.extend({},c.result(this,"options"),b),this.listenTo(a,"start",function(){this.trigger("start"),this.listenTo(a,this.options.listenTo?this.options.listenTo:"add change remove",this.sync),this.sync(),this._isInitialized=!0}),this.initialize.apply(this,arguments)}var g=b.Prism=b.Prism||{};g.VERSION="1.0.0",g.extend=b.Model.extend;var h=function(a,b){a&&c.extend(this,c.pick(a,b))},i=function(a,b){return a&&b?a.options&&void 0!==a.options[b]?a.options[b]:a[b]:void 0},j=function(a){return i(this,a)},k=function(a,b){a.register(function(a){var d=a.source,e=a.action,f=e.type;if(-1!==f.indexOf(":")){if("undefined"!=typeof this.name&&f.split(":")[0]!==this.name)return;f=f.split(":")[1]}var g=e.data,h=e.options?e.options:{};c.isFunction(b[f])&&b[f].call(this,g,h,d)}.bind(this))},l=function(){return this.trigger("destroy"),this.stopListening(),this.off(),this};g.Object=function(a){this.options=c.extend({},c.result(this,"options"),a),this.initialize.apply(this,arguments)},g.Object.extend=g.extend,c.extend(g.Object.prototype,b.Events,{initialize:function(){},mergeOptions:h,getOption:j,destroy:l}),g.Dispatcher=function(){d.Dispatcher.prototype.constructor.apply(this,arguments)},g.Dispatcher.prototype=new d.Dispatcher,c.extend(g.Dispatcher.prototype,{handleViewAction:function(a){this.dispatch({source:"view",action:a})},handleServerAction:function(a){this.dispatch({source:"server",action:a})}});var m=g.Object.extend({initialize:function(a,b,c){this.parent=a,this.context=b,this.callback=c,a.on("start",this.update(null,!0))},apply:function(a){a&&c.extend(this.context.state,a),c.extend(this.parent.options,this.callback.call(this.context))},update:function(a,b){return function(){this.apply(a),b!==!0&&this.trigger("apply",a)}.bind(this)}});g.ViewMutator=m;var n=m.extend({apply:function(){c.extend(this.parent.options,{comparator:this.callback.call(this.context)})}});g.ViewComparator=n;var o=m.extend({apply:function(){this.parent.options.filters=this.parent.options.filters||{},this.parent.options.filters[this.cid]=this.callback.call(this.context)}});g.ViewFilter=o;var p={mutators:{},createMutator:function(a,b){var d=new m(this,b,a);return d.cid=c.uniqueId("mutator"),this._storeMutator(d),d},_storeMutator:function(a){this.listenTo(a,"apply",function(a){this.sync(a)}),this.listenTo(a,"destroy",function(){this.stopListening(a),delete this.mutators[a.cid],this.sync()}),this.mutators[a.cid]=a}};g.MutatorMixin=p,c.extend(e.prototype,b.Events,b.Radio.Commands,b.Radio.Requests,p,{sync:function(a){this.attrs=c.extend({cid:this.state.cid},this.state.attributes),this.trigger("sync",a)},toJSON:function(){return c.extend({cid:this.state.cid},this.attrs)},destroy:l}),g.StateView=e;var q={views:{},_isInitialized:!1,start:function(){this.trigger("start"),this._isInitialized=!0},getView:function(a){return this.views[a]},register:k};g.StateMixin=c.extend({createView:function(a){var b=new e(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,b},getDefaultView:function(){if(this.views["default"])return this.views["default"];var a=new e(this,{});return a.name="default",this.views["default"]=a,a}},q),g.State=b.Model.extend(g.StateMixin),c.extend(f.prototype,b.Events,b.Radio.Commands,b.Radio.Requests,p,{initialize:function(){},sync:function(a){if(this.models=c.clone(this.store.models),this.options.filter)if(c.isFunction(this.options.filter))this.models=this.filter(this.options.filter);else if(c.isObject(this.options.filter)){var b=c.matches(this.options.filter);this.models=this.filter(function(a){return b(a.attributes)})}if(this.options.filters&&c.each(this.options.filters,function(a){this.models=this.filter(a)}.bind(this)),this.options.comparator&&this.models.sort(c.bind(this.options.comparator,this)),this.length=this.models.length,this.options.size||"undefined"!=typeof this.options.offset){var d=this.models.length,e=this.options.size||d,f="undefined"==typeof this.options.offset?0:Math.abs(this.options.offset);if(e>0)this.models=this.models.slice(f,f+e);else if(0>e){var g=Math.abs(d+e-f);this.models=this.models.slice(g,d-f)}}this.size=this.models.length,this.trigger("sync",a)},toJSON:function(){return this.models.map(function(a){return c.extend({cid:a.cid},a.toJSON())})},createFilter:function(a,b){var d=new o(this,b,a);return d.cid=c.uniqueId("filter"),this._storeMutator(d),d},createComparator:function(a,b){var d=new n(this,b,a);return d.cid=c.uniqueId("comparator"),this._storeMutator(d),d},destroy:l});var r=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];return c.each(r,function(a){f.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}}),c.each(["groupBy","countBy","sortBy","indexBy"],function(a){f.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)}}),g.StoreView=f,g.StoreMixin=c.extend({createView:function(a){var b=new f(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,this.listenTo(b,"destroy",function(){delete this.views[b.name]}),b},getDefaultView:function(){if(this.views["default"])return this.views["default"];var a=new f(this,{});return a.name="default",this.views["default"]=a,this.listenTo(a,"destroy",function(){delete this.views["default"]}),a}},q),g.Store=b.Collection.extend(g.StoreMixin),g.ViewMixin=c.extend({getInitialState:function(){return c.isFunction(this.transform)?this.transform(this.props.view):{view:this.props.view.toJSON()}},componentDidMount:function(){this.listenTo(this.props.view,"sync",function(){this.setState(c.isFunction(this.transform)?this.transform(this.props.view):{view:this.props.view.toJSON()})})},componentWillUnmount:function(){this.stopListening(this.props.view,"sync")}},b.Events),g});