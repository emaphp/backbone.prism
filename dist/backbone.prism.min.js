!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore","flux","backbone.radio"],function(c,d,e){return b(a,c,d,e)});else if("undefined"!=typeof exports){require("backbone.radio");module.exports=b(a,require("backbone"),require("underscore"),require("flux"))}else b(a,a.Backbone,a._,a.Flux)}(this,function(a,b,c,d){function e(a,b){this.parent=a,this.options=c.extend({},c.result(this,"options"),b),this.options.listenTo=this.options.listenTo||"change",this._isInitialized=!1,this.listenTo(a,"start",function(){this.trigger("start"),this.wakeup(),this._isInitialized=!0}),this.initialize.apply(this,arguments)}function f(a,b){this.parent=a,this.models=[],this.length=0,this._isInitialized=!1,this.options=c.extend({},c.result(this,"options"),b),this.options.listenTo=this.options.listenTo||"add remove change reset",this.listenTo(a,"start",function(){this.trigger("start"),this.wakeup(),this._isInitialized=!0}),this.initialize.apply(this,arguments)}var g=b.Prism=b.Prism||{};g.VERSION="1.1.2",g.extend=b.Model.extend;var h=function(a,b){a&&c.extend(this,c.pick(a,b))},i=function(a,b){return a&&b?a.options&&void 0!==a.options[b]?a.options[b]:a[b]:void 0},j=function(a){return i(this,a)},k=function(a,b){return this._id=this._id||c.uniqueId("store"),a.stores[this._id]=a.stores[this._id]||this,a.register(function(a){var d,e=a.action,f=a.source,g=e.type;if(-1!==g.indexOf(":")){if(d=g.split(":")[0],"*"!==d&&"undefined"!=typeof this.name&&d!==this.name)return;g=g.split(":")[1]}var h=e.data,i=e.options?e.options:{};c.isFunction(b[g])&&b[g].call(this,h,i,f)}.bind(this))},l=function(){return this.trigger("destroy"),this.stopListening(),this.off(),this};g.Object=function(a){this.options=c.extend({},c.result(this,"options"),a),this.initialize.apply(this,arguments)},g.Object.extend=g.extend,c.extend(g.Object.prototype,b.Events,{initialize:function(){},mergeOptions:h,getOption:j,destroy:l}),g.Channel=g.Object.extend(c.extend({destroy:function(){return this.off(),this.stopListening(),this.stopReplying(),this}},b.Radio.Requests)),g.Events=c.extend({},b.Events,b.Radio.Requests),g.Dispatcher=function(){this.stores={},d.Dispatcher.prototype.constructor.apply(this,arguments)},g.Dispatcher.prototype=new d.Dispatcher,c.extend(g.Dispatcher.prototype,{handleViewAction:function(a){return this.dispatch({source:"view",action:a})},handleServerAction:function(a){return this.dispatch({source:"server",action:a})}});var m=g.Object.extend({initialize:function(a,b,c){this.parent=a,this.context=b,this.callback=c,a.on("start",this.update(!0))},apply:function(a){c.extend(this.parent.options,this.callback.call(this.context)),a!==!0&&this.trigger("apply")},update:function(a){return function(){this.apply(a)}.bind(this)}});g.ViewMutator=m;var n=m.extend({apply:function(a){c.extend(this.parent.options,{comparator:this.callback.call(this.context)}),a!==!0&&this.trigger("apply")}});g.ViewComparator=n;var o=m.extend({apply:function(a){this.parent.options.filters=this.parent.options.filters||{},this.parent.options.filters[this.cid]=this.callback.call(this.context),a!==!0&&this.trigger("apply")}});g.ViewFilter=o;var p=c.extend({mutators:{},createMutator:function(a,b){var d=new m(this,b,a);return d.cid=c.uniqueId("mutator"),this._storeMutator(d),d},_storeMutator:function(a){this.listenTo(a,"apply",function(a){this.sync(a)}),this.listenTo(a,"destroy",function(){this.stopListening(a),delete this.mutators[a.cid],this.sync()}),this.mutators[a.cid]=a},_isActive:!1,sleep:function(){this.stopListening(this.parent,this.options.listenTo),this._isActive=!1},wakeup:function(a){this.listenTo(this.parent,this.options.listenTo,this.sync),this._isActive=!0,a!==!1&&this.sync()}},b.Events),q={views:{},_isInitialized:!1,start:function(){this.trigger("start"),this._isInitialized=!0},getView:function(a){return this.views[a]},register:k};c.extend(e.prototype,p,{initialize:function(){},sync:function(){this.attributes=c.extend({cid:this.parent.cid},this.parent.attributes),this.trigger("sync")},toJSON:function(){return c.extend({cid:this.parent.cid},this.attributes)},destroy:l}),e.extend=b.Model.extend,g.StateView=e,g.StateMixin=c.extend({constructor:function(a,b){var d=a||{};b=b||{},this.cid=c.uniqueId("c"),this.attributes={},this.views={},b.collection&&(this.collection=b.collection),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this.changed={},this.initialize.apply(this,arguments)},createView:function(a){a=a||{};var b=new e(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,this.listenTo(b,"destroy",function(){delete this.views[b.name]}),b},getDefaultView:function(){if(this.views["default"])return this.views["default"];var a=new e(this,{});return a.name="default",this.views["default"]=a,this.listenTo(a,"destroy",function(){delete this.views[a.name]}),a}},q),g.State=b.Model.extend(g.StateMixin),c.extend(f.prototype,p,{initialize:function(){},sync:function(){if(this.models=c.clone(this.parent.models),this.options.filter)if(c.isFunction(this.options.filter))this.models=this.filter(this.options.filter);else if(c.isObject(this.options.filter)){var a=c.matches(this.options.filter);this.models=this.filter(function(b){return a(b.attributes)})}if(this.options.filters&&c.each(this.options.filters,function(a){if(c.isFunction(a))this.models=this.filter(a);else if(c.isObject()){var b=c.matches(a);this.models=this.filter(function(a){return b(a.attributes)})}}.bind(this)),this.options.comparator&&(c.isString(this.options.comparator)||1===this.options.comparator.length?this.models=this.sortBy(this.options.comparator,this):this.models.sort(c.bind(this.options.comparator,this))),this.length=this.models.length,this.options.size||"undefined"!=typeof this.options.offset){var b=this.models.length,d=this.options.size||b,e="undefined"==typeof this.options.offset?0:Math.abs(this.options.offset);if(d>0)this.models=this.models.slice(e,e+d);else if(0>d){var f=Math.abs(b+d-e);this.models=this.models.slice(f,b-e)}}this.size=this.models.length,this.trigger("sync")},toJSON:function(){return this.models.map(function(a){return c.extend({cid:a.cid},a.toJSON())})},createFilter:function(a,b){var d=new o(this,b,a);return d.cid=c.uniqueId("filter"),this._storeMutator(d),d},createComparator:function(a,b){var d=new n(this,b,a);return d.cid=c.uniqueId("comparator"),this._storeMutator(d),d},destroy:l});var r=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];return c.each(r,function(a){f.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}}),c.each(["groupBy","countBy","sortBy","indexBy"],function(a){f.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)}}),f.extend=b.Model.extend,g.StoreView=f,g.StoreMixin=c.extend({constructor:function(a,b){b=b||{},b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.views={},this.initialize.apply(this,arguments),a&&this.reset(a,c.extend({silent:!0},b))},createView:function(a){a=a||{};var b=new f(this,a);return b.name=a.name?a.name:c.uniqueId("view"),this.views[b.name]=b,this.listenTo(b,"destroy",function(){delete this.views[b.name]}),b},getDefaultView:function(){if(this.views["default"])return this.views["default"];var a=new f(this,{});return a.name="default",this.views["default"]=a,this.listenTo(a,"destroy",function(){delete this.views["default"]}),a}},q),g.Store=b.Collection.extend(g.StoreMixin),g.ViewMixin=c.extend({getInitialState:function(){return c.isFunction(this.transform)?this.transform(this.props.view):{view:this.props.view.toJSON()}},componentDidMount:function(){this.listenTo(this.props.view,"sync",function(){this.setState(c.isFunction(this.transform)?this.transform(this.props.view):{view:this.props.view.toJSON()})})},componentWillUnmount:function(){this.stopListening(this.props.view,"sync")},mergeState:function(a,b){c.extend(this.state,a),b&&b()}},b.Events),g});
